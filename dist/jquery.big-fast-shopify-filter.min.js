/*
 *  jquery-bigFastShopifyFilter - vv0.0.1
 *  Designed to sort and filter products using key value pairs in tags and metafields. Performs much faster on massive collections, and includes infinite scroll pagination
 *  http://colinbrogan.info/dev/big-fast-shopify-filter
 *
 *  Made by Colin Brogan
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="bigFastShopifyFilter",g={filter_criteria:null,collection_handle:null,paginate:30,key_value_overrides:null,metafields:null,tagfields:null,price:{enable:!0,ui_label:"Price",ui_component:"range-slider",placement:"sidebar",range_splits:4},vendor:{enable:!0,ui_component:"sidebar",placement:"sidebar",one_option_hide:!0},type:{enable:!0,ui_component:"checkbox-button-group",placement:"sidebar",one_option_hide:!0}},h=null;a.extend(e.prototype,{init:function(){if(a(this.element).data("collection")===d)return!1;this.setCollectionHandle(a(this.element).data("collection"));var b=a(this.element).find("ul.product-grid").data("fast-start");if(b!==d){var c=b;this.storeAllReceived(c)}var e=this;a(this.element).on("loadReceived",function(a,b){console.log("loadReceived"),e.storeAllReceived(b),e.filter()}),a(this.element).on("loadsFinished",function(){console.log("loadsFinished event fired")})},filtered:{},filter_options:{},allReceived:{},displayEndIndex:0,collection_handle:null,filter_criteria:null,all_loads_in:!1,sort_property:"price",queuedForScroll:[],$productGrid:a(),scroll_adding:!1,page:1,go:function(b){a(this.element).find("ul.product-grid").empty(),console.log("go fired"),this.queuedForScroll=[],this.filter_criteria=b,this.page=1;var c=a(this.element);if(this.filter(),console.log("something has been changed 2"),this.all_loads_in===!1){var d=function(a){c.trigger("loadReceived",a)},e=this,f=function(){console.log("done fired here"),e.all_loads_in=!0;var b=!0;for(var c in e.filtered){b=!1;break}console.log("filteredEmpty"),console.log(b),b&&a("ul.product-grid").html(["<li class='emtpy-message'>","Nothing matched your filter criteria.","<a href='#' class='clear-all'>","Clear All <i class='icon icon-close'></i>","</a>","</li>"].join(""))};console.log("whenDone variable name changed"),console.log(f),Shopify.Mazer.pipeInCollection.go(this.collection_handle,d,1,f)}},filter:function(){this.filtered={};for(var a in this.allReceived){var b=!0;this.allReceived[a].metafields.Location!==d&&("41shop"==this.allReceived[a].metafields.Location.toLowerCase()||"41scrap"==this.allReceived[a].metafields.Location.toLowerCase())&&(b=!1),("S&D"==this.allReceived[a].metafields.Condition||"NITB"==this.allReceived[a].metafields.Condition)&&this.allReceived[a].info.variants[0].inventory_quantity<=0?b=!1:this.allReceived[a].metafields.Condition==d&&(b=!1);for(var c in this.filter_criteria)if(this.settings.metafields.hasOwnProperty(c))for(var e in this.allReceived[a].metafields){var f=this.allReceived[a].metafields[e];if(e===c)if(this.filter_criteria[c].constructor==Array){var g=!1;for(var h in this.filter_criteria[c]){var i=decodeURIComponent(this.filter_criteria[c][h].replace(/\+/g,"%20"));f===i&&(g=!0)}g||(b=!1)}else{var i=decodeURIComponent(this.filter_criteria[c].replace(/\+/g,"%20"));f===i||(b=!1)}}else if(this.settings.tagfields.hasOwnProperty(c))for(var j in this.allReceived[a].info.tags){var k=this.allReceived[a].info.tags[j];if(0===k.indexOf("kvp:"+c)){var l=k.split(":"),m=l[1],n=l[2];if(m===c)if(this.filter_criteria[c].constructor==Array){var g=!1;for(var h in this.filter_criteria[c]){var i=decodeURIComponent(this.filter_criteria[c][h].replace(/\+/g,"%20"));n===i&&(g=!0)}g||(b=!1)}else{var i=decodeURIComponent(this.filter_criteria[c].replace(/\+/g,"%20"));i===n||(b=!1)}}}b&&(this.filtered[a]=this.allReceived[a])}console.log(this.filtered),this.trickleToGrid()},storeAllReceived:function(a){null==this.allReceived&&(this.allReceived={});for(var b in a.products){a:for(var c in a.products[b].metafields){var d=a.products[b].metafields[c];if(this.settings.metafields.hasOwnProperty(c)){if(this.filter_options.hasOwnProperty(c)){if(this.filter_options[c].hasOwnProperty(d))continue a;this.filter_options[c][d]={}}else this.filter_options[c]={},this.filter_options[c][d]={};if(this.settings.filter_values.hasOwnProperty(c))if(this.settings.filter_values[c].hasOwnProperty(d)){var e=this.settings.filter_values[c][d].label,f=this.settings.filter_values[c][d].color,g=this.settings.filter_values[c][d].image;this.filter_options[c][d].label=e?e:d,f&&(this.filter_options[c][d].color=f),g&&(this.filter_options[c][d].image=g)}else this.filter_options[c][d].label=d;else this.filter_options[c][d].label=d}}a:for(var h in a.products[b].info.tags){var i=a.products[b].info.tags[h];if(0===i.indexOf("kvp:")){var j=i.split(":"),k=j[1],l=j[2];if(this.settings.tagfields.hasOwnProperty(k)){if(this.filter_options.hasOwnProperty(k)){if(this.filter_options[k].hasOwnProperty(l))continue a;this.filter_options[k][l]={}}else this.filter_options[k]={},this.filter_options[k][l]={};if(this.settings.filter_values.hasOwnProperty(k))if(this.settings.filter_values[k].hasOwnProperty(l)){var e=this.settings.filter_values[k][l].label,f=this.settings.filter_values[k][l].color,g=this.settings.filter_values[k][l].image;this.filter_options[k][l].label=e?e:l,f&&(this.filter_options[k][l].color=f),g&&(this.filter_options[k][l].image=g)}else this.filter_options[k][l].label=l;else this.filter_options[k][l].label=l}}}this.allReceived[b]=a.products[b]}console.log("Current allReceived "+this.allReceived.length+" items."),console.log(this.allReceived)},renderOptions:function(){console.log(this.filter_options);var a="";for(var b in this.filter_options){a+="<h3>"+b.toUpperCase()+"</h3>",a+='<ul class="tick-boxes">';for(var c in this.filter_options[b]){var d=this.filter_options[b][c],e="";if(this.filter_criteria.hasOwnProperty(encodeURIComponent(b).replace(/%20/g,"+")))if(this.filter_criteria[encodeURIComponent(b).replace(/%20/g,"+")]===encodeURIComponent(c).replace(/%20/g,"+"))e+="active";else if(this.filter_criteria[encodeURIComponent(b)].constructor===Array)for(var f in this.filter_criteria[encodeURIComponent(b).replace(/%20/g,"+")])this.filter_criteria[encodeURIComponent(b)][f]===encodeURIComponent(c).replace(/%20/g,"+")&&(e+="active");var g="";d.color&&(g+="background-color: "+d.color+"; ",parseInt(d.color.replace("#",""),16)<10329501&&(e+=" white-tick")),d.image&&(g+="background-image: url("+d.image+"); "),a+='<li><button class="'+e+'" name="'+b+'" value="'+c+'"><div class="tick-box" style="'+g+'"></div>'+d.label+"</button></li>"}a+="</ul>"}return a},getAllReceived:function(){return this.allReceived},trickleToGrid:function(){a(".show-results").remove();var b=this.collection_handle,c=function(a){var c={};for(var e in a.info.tags){var f=a.info.tags[e];if(0===f.indexOf("kvp:")){var g=f.split(":");c[g[1]]=g[2]}}var h="";switch(a.metafields.Condition){case"S&D":h="Scratch & Dent";break;case"NITB":h="New In Box";break;case"SO":h="Special Order";break;case"CO":h="Closeout"}var i="",j=a.info.images[0];j&&(i="LG"==a.info.vendor?'<img src="'+j.replace(".jpeg","_medium.jpeg")+'" class="'+a.info.vendor.replace(" ","-")+'" alt="" />':'<img src="'+j.replace(".jpeg","_small.jpeg")+'" class="'+a.info.vendor.replace(" ","-")+'" alt="" />');var k="";a.metafields.Location!==d&&(k=['<div class="spec-wrap">',"<dt>LOCATION</dt>","<dd>"+a.metafields.Location+"</dd>","</div>"].join(""));var l="";"Total Capacity (cubic feet)"in c&&(l=['<div class="spec-wrap">',"<dt>CAPACITY</dt>","<dd>"+c["Total Capacity (cubic feet)"]+"</dd>","</div>"].join(""));var m="";"dBA"in c&&(m=['<div class="spec-wrap">',"<dt>Decibals</dt>","<dd>"+c.dBA+"</dd>","</div>"].join(""));var n="";"Sones"in c&&(n=['<div class="spec-wrap">',"<dt>Sones</dt>","<dd>"+c.Sones+"</dd>","</div>"].join(""));var o="";"CFM"in c&&(o=['<div class="spec-wrap">',"<dt>CFM</dt>","<dd>"+c.CFM+"</dd>","</div>"].join(""));var p=a.info.title;return"LG"==a.info.vendor&&a.info.title.indexOf("LG")<0&&(p="LG "+p),["<li id='p"+a.info.id+"' class='"+a.metafields.Condition.toLowerCase().replace("&","")+"'>",'<div class="snapshot">','<a href="/collections/'+b+"/products/"+a.info.handle+'" class="product-image">',i,"</a>",'<dl class="specs">','<div class="spec-wrap">',"<dt>MODEL</dt>","<dd>"+a.info.handle.split("-")[0]+"</dd>","</div>",'<div class="spec-wrap">',"<dt>SERIAL</dt>","<dd>"+a.info.handle.split("-")[1]+"</dd>","</div>",l,k,m,o,n,'<div class="spec-wrap long">',"<dt>DIMENSIONS</dt>","<dd>"+c["Overall Width"]+'"W x '+c["Overall Height"]+'"H x '+c["Overall Depth"]+'"D</dd>',"</div>","</dl>","</div>",'<div class="price-condition">','<dl class="price">',"<dt><span hidden>Price</span></dt>","<dd>$"+a.info.price/100+"</dd>","</dl>",'<div class="count-breakout">',"<div>",'<span class="tag-count '+a.metafields.Condition.replace("&","").toLowerCase()+'">',h,"</span>","</div>","</div>","</div>",'<h4 class="product-title"><a href="/collections/'+b+"/products/"+a.info.handle+'">'+p+"</a></h4>","</li>"].join("")},e=this,f=function(b,c,d){var f=!1,g=!1;if(b.find("li").length>0){var h=function(h){var j=a(this).attr("data-filter-index");if(e.filtered[j].info.id==e.filtered[i].info.id)return g=!0,!1;if(e.filtered[i].info[e.sort_property]<e.filtered[j].info[e.sort_property]){if(a(this).before(c),b.find("li").length>d){var k=b.find("li:last-child");f=k.clone(),k.remove()}return g=!0,!1}return h==b.find("li").length-1&&d-1>h?(a(this).after(c),g=!0,!1):void 0};b.find("li").each(h)}else b.append(c),g=!0;return{placed_item:g,add_to_next:f}},g=!0,h=a("ul.product-grid").clone();for(var i in this.filtered){g=!1;var j=a(c(this.filtered[i])).attr("data-filter-index",i),k=this.settings.paginate*this.page,l=f(h,j,k);if(l.add_to_next&&this.queuedForScroll.unshift(l.add_to_next),!l.placed_item)if(this.queuedForScroll.length>0)for(var m in this.queuedForScroll){var n=a(this.queuedForScroll[m]).attr("data-filter-index"),o=0;if(e.filtered[n].info.id==e.filtered[i].info.id){o=1;break}if(e.filtered[i].info[e.sort_property]<e.filtered[n].info[e.sort_property]){o=2,this.queuedForScroll.splice(m-1,0,j);break}if(m==this.queuedForScroll.length-1){o=3,this.queuedForScroll.push(j);break}}else this.queuedForScroll.push(j)}a("ul.product-grid").replaceWith(h),this.addResultsButton(),this.all_loads_in&&a(this.element).trigger("loadsFinished"),g&&this.all_loads_in&&a("ul.product-grid").html(["<li class='emtpy-message'>","Nothing matched your filter criteria.","<a href='#' class='clear-all'>","Clear All <i class='icon icon-close'></i>","</a>","</li>"].join("")),console.log("this.queuedForScroll"),console.log(this.queuedForScroll),a(this.element).find("#options-go-here").empty(),a(this.element).find("#options-go-here").append(this.renderOptions()),console.log("renderOptions appended"),this.registerActions()},addResultsButton:function(){if(this.queuedForScroll.length>0){var b=this.settings.paginate;this.queuedForScroll.length<b&&(b=this.queuedForScroll.length);var c=a(['<div class="show-results">','<button class="btn btn-purple" id="add-results">',"Show "+b+" more results.","</button>","</div>"].join(""));a(".show-results").length>0?a(".show-results").replaceWith(c):a("ul.product-grid").after(c);var d=this;a("#add-results").click(function(){d.infiniteScroll()})}else a(".show-results").replaceWith(['<div class="show-results">','<button class="btn disabled" id="add-results">',"You've reached the end","</button>","</div>"].join(""))},registerActions:function(){a("ul.tick-boxes button").click(function(b){b.preventDefault(),a(this).toggleClass("active");var c={};a(this).parents("#options-go-here").find("ul.tick-boxes button.active").each(function(){var b=a(this).attr("name"),e=a(this).attr("value");c[b]==d&&(c[b]=[]),c[b].push(e)});var e=jQuery.param(c,!0);console.log(e),a.address.queryString(e)}),a("a.clear-all").click(function(b){b.preventDefault(),a.address.queryString("")});var b=this;a("#add-results").click(function(){b.infiniteScroll()})},infiniteScroll:function(){var b=this,c=function(){a("ul.product-grid").removeClass("adding-products"),console.log("hit infiniteScroll"),b.page=b.page+1;var c=0;for(console.log(b.settings.paginate),console.log(b.queuedForScroll);c<b.settings.paginate;)console.log(c),a("ul.product-grid").append(b.queuedForScroll.shift()),c++;b.scroll_adding=!1};c(),this.addResultsButton()},refresh:function(){console.log("refresh"),somePrivateMethod("refresh")},setCollectionHandle:function(a){this.collection_handle=a},getSomeInfo:function(){return this.someInfo},getPrivateInfo:function(){return h}}),a.fn[f]=function(b){var c=arguments;if(b===d||"object"==typeof b)return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var g;return this.each(function(){var d=a.data(this,"plugin_"+f);d instanceof e&&"function"==typeof d[b]&&(g=d[b].apply(d,Array.prototype.slice.call(c,1))),"destroy"===b&&a.data(this,"plugin_"+f,null)}),g!==d?g:this}}}(jQuery,window,document);