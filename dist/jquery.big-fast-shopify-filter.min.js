/*
 *  jquery-bigFastShopifyFilter - vv0.0.1
 *  Designed to sort and filter products using key value pairs in tags and metafields. Performs much faster on massive collections, and includes infinite scroll pagination
 *  http://colinbrogan.info/dev/big-fast-shopify-filter
 *
 *  Made by Colin Brogan
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="bigFastShopifyFilter",g={filter_criteria:null,collection_handle:null,paginate:30,key_value_overrides:null,metafields:null,tagfields:null,price:{enable:!0,ui_label:"Price",ui_component:"range-slider",placement:"sidebar",range_splits:4},vendor:{enable:!0,ui_component:"sidebar",placement:"sidebar",one_option_hide:!0},type:{enable:!0,ui_component:"checkbox-button-group",placement:"sidebar",one_option_hide:!0}},h=null;a.extend(e.prototype,{init:function(){if(a(this.element).data("collection")===d)return!1;this.setCollectionHandle(a(this.element).data("collection"));var b=a(this.element).find("ul.product-grid").data("fast-start");if(b!==d){var c=b;this.storeAllReceived(c)}var e=this;a(this.element).on("loadReceived",function(a,b){console.log("A load was received"),e.storeAllReceived(b),(b.page-1)%7==0&&(e.filter(),e.buildOptions())}),a(this.element).on("loadsFinished",function(){console.log("Finished all Loads"),e.buildOptions(),e.filter(),a("#options-go-here").removeClass("loading")}),a(this.element).on("filterOptionsChanged",function(){e.setActiveOptionsToHash()})},filtered:{},filter_options:{},allReceived:{},displayEndIndex:0,collection_handle:null,filter_criteria:null,all_loads_in:!1,sort_property:"price",queuedForScroll:[],$productGrid:a(),scroll_adding:!1,page:1,go:function(b){a(this.element).find("ul.product-grid").empty(),this.queuedForScroll=[],this.filter_criteria=b;var c=a(this.element);if(this.filter(),this.buildOptions(),this.sendGAEvents(b),this.all_loads_in===!1){var d=function(a){c.trigger("loadReceived",a)},e=this,f=function(b){e.all_loads_in=!0;var d=!0;for(var f in e.filtered){d=!1;break}d&&a("ul.product-grid").html(["<li class='emtpy-message'>","Nothing matched your filter criteria.","<a href='#' class='clear-all'>","Clear All <i class='icon icon-close'></i>","</a>","</li>"].join("")),c.trigger("loadsFinished",b)};Shopify.Mazer.pipeInCollection.go(this.collection_handle,d,1,f)}},sendGAEvents:function(a){console.log("sendGAEvents!");for(var b in a)console.log("ga('send', 'event', 'Filtering Collection with', '"+b+": "+a[b]+"');"),ga("send","event","Filtering Collection with",b+": "+a[b])},fastReload:function(b){a(this.element).find("ul.product-grid").empty(),this.queuedForScroll=[],this.filter_criteria=b;a(this.element);this.filter(),this.sendGAEvents(b)},filter:function(){a(this.element).find("ul.product-grid").addClass("loading"),this.filtered={};for(var b in this.allReceived){var c=!0;if(this.allReceived[b].metafields.Location===d||"41shop"!=this.allReceived[b].metafields.Location.toLowerCase()&&"41scrap"!=this.allReceived[b].metafields.Location.toLowerCase())if(("S&D"==this.allReceived[b].metafields.Condition||"NITB"==this.allReceived[b].metafields.Condition)&&this.allReceived[b].info.variants[0].inventory_quantity<=0)c=!1;else if(this.allReceived[b].metafields.Condition!=d){for(var e in this.filter_criteria){var f=decodeURIComponent(e.replace(/\+/g,"%20"));if(this.settings.metafields.hasOwnProperty(f))for(var g in this.allReceived[b].metafields){var h=this.allReceived[b].metafields[g];if(g===e)if(this.filter_criteria[e].constructor==Array){var i=!1;for(var j in this.filter_criteria[e]){var k=decodeURIComponent(this.filter_criteria[e][j].replace(/\+/g,"%20"));h===k&&(i=!0)}if(!i){c=!1;continue}}else{var k=decodeURIComponent(this.filter_criteria[e].replace(/\+/g,"%20"));if(h!==k){c=!1;continue}}}else if(this.settings.tagfields.hasOwnProperty(f)){var l=!1;for(var m in this.allReceived[b].info.tags){var n=this.allReceived[b].info.tags[m];if(0===n.indexOf("kvp:"+f)){l=!0;var o=n.split(":"),p=o[1],q=o[2];if(p==decodeURIComponent(e.replace(/\+/g,"%20")))if(this.filter_criteria[e].constructor==Array){var i=!1;for(var j in this.filter_criteria[e]){var k=decodeURIComponent(this.filter_criteria[e][j].replace(/\+/g,"%20"));q===k&&(i=!0)}if(!i){c=!1;continue}}else{var k=decodeURIComponent(this.filter_criteria[e].replace(/\+/g,"%20"));if(k!==q){c=!1;continue}}}}if(0==l){c=!1;continue}}else if(this.settings.type.enable&&"Type"==e)if(this.filter_criteria[e].constructor==Array){var i=!1;for(var j in this.filter_criteria[e]){var k=decodeURIComponent(this.filter_criteria[e][j].replace(/\+/g,"%20"));this.allReceived[b].info.type===k&&(i=!0)}if(!i){c=!1;continue}}else{var r=decodeURIComponent(this.filter_criteria[e].replace(/\+/g,"%20"));if(this.allReceived[b].info.type!=r){c=!1;continue}}}c&&(this.filtered[b]=this.allReceived[b])}else c=!1;else c=!1}this.trickleToGrid()},storeAllReceived:function(a){null==this.allReceived&&(this.allReceived={});for(var b in a.products){a:for(var c in a.products[b].metafields){var e=a.products[b].metafields[c];if(this.settings.metafields.hasOwnProperty(c)){if(this.filter_options.hasOwnProperty(c)){if(this.filter_options[c].hasOwnProperty(e))continue a;this.filter_options[c][e]={}}else this.filter_options[c]={},this.filter_options[c][e]={};if(this.settings.filter_values.hasOwnProperty(c))if(this.settings.filter_values[c].hasOwnProperty(e)){var f=this.settings.filter_values[c][e].label,g=this.settings.filter_values[c][e].color,h=this.settings.filter_values[c][e].image;this.filter_options[c][e].label=f?f:e,g&&(this.filter_options[c][e].color=g),h&&(this.filter_options[c][e].image=h)}else this.filter_options[c][e].label=e;else this.filter_options[c][e].label=e}}a:for(var i=0;i<a.products[b].info.tags.length;i++){var j=a.products[b].info.tags[i];if("sale"==j?(a.products[b].info.tags.push("kvp:Clearance:On Sale"),console.log("Pushed Clearance:On Sale"),console.log(b),console.log(a.products[b].info.tags)):"Markdown"==j&&(a.products[b].info.tags.push("kvp:Clearance:Marked Down"),console.log("Pushed Clearance:Marked Down"),console.log(b),console.log(a.products[b].info.tags)),0===j.indexOf("kvp:")){var k=j.split(":"),l=k[1];"Clearance"==l&&console.log("Hit a Clearance!");var m=k[2];if(this.settings.tagfields.hasOwnProperty(l)){if(this.filter_options.hasOwnProperty(l)){if(this.filter_options[l].hasOwnProperty(m))continue a;this.filter_options[l][m]={}}else this.filter_options[l]={},this.filter_options[l][m]={};if(this.settings.filter_values.hasOwnProperty(l))if(this.settings.filter_values[l].hasOwnProperty(m)){var f=this.settings.filter_values[l][m].label,g=this.settings.filter_values[l][m].color,h=this.settings.filter_values[l][m].image;this.filter_options[l][m].label=f?f:m,g&&(this.filter_options[l][m].color=g),h&&(this.filter_options[l][m].image=h)}else this.filter_options[l][m].label=m;else this.filter_options[l][m].label=m}}}this.settings.type.enable&&(this.filter_options.Type===d?this.filter_options.Type={}:(this.filter_options.Type[a.products[b].info.type]={},this.filter_options.Type[a.products[b].info.type].label=a.products[b].info.type)),this.allReceived[b]=a.products[b]}console.log("this.allReceived"),console.log(this.allReceived)},renderOptions:function(){var a="";for(var b in this.filter_options){var c=b.toUpperCase();this.settings.tagfields.hasOwnProperty(b)?c=this.settings.tagfields[b].ui_label:this.settings.metafields.hasOwnProperty(b)&&(c=this.settings.metafields[b].ui_label),a+="CONDITION"==b.toUpperCase()||"KIND"==b.toUpperCase()||"TYPE"==b.toUpperCase()||"TRUCKLOAD"==b.toUpperCase()||"CLEARANCE"==b.toUpperCase()?"<h3 class='active'>"+c+"</h3>":this.filter_criteria.hasOwnProperty(encodeURIComponent(b).replace(/%20/g,"+"))?"<h3 class='active'>"+c+"</h3>":"<h3>"+c+"</h3>",a+='<ul class="tick-boxes">';for(var d in this.filter_options[b]){var e=this.filter_options[b][d],f="";if(this.filter_criteria.hasOwnProperty(encodeURIComponent(b).replace(/%20/g,"+")))if(this.filter_criteria[encodeURIComponent(b).replace(/%20/g,"+")]===encodeURIComponent(d).replace(/%20/g,"+"))f+="active";else if(this.filter_criteria[encodeURIComponent(b).replace(/%20/g,"+")].constructor===Array)for(var g in this.filter_criteria[encodeURIComponent(b).replace(/%20/g,"+")])this.filter_criteria[encodeURIComponent(b)][g]===encodeURIComponent(d).replace(/%20/g,"+")&&(f+="active");var h="";"Clearance"==d&&(e.color="#a56060",f+=" white-tick"),e.color&&(h+="background-color: "+e.color+"; ",parseInt(e.color.replace("#",""),16)<10329501&&(f+=" white-tick")),e.image&&(h+="background-image: url("+e.image+"); "),a+='<li><button class="'+f+'" name="'+b+'" value="'+d+'"><div class="tick-box" style="'+h+'"></div>'+e.label+"</button></li>"}a+="</ul>"}return a},buildOptions:function(){a(this.element).find("#options-go-here").empty(),a(this.element).find("#options-go-here").addClass("loading").append(this.renderOptions()),this.registerActions()},getAllReceived:function(){return this.allReceived},trickleToGrid:function(){a(".show-results").remove();var b=this.collection_handle,c=function(a){var c={};for(var d in a.info.tags){var e=a.info.tags[d];if(0===e.indexOf("kvp:")){var f=e.split(":");c[f[1]]=f[2]}}var g="";switch(a.metafields.Condition){case"S&D":g="Scratch & Dent";break;case"NITB":g="New In Box";break;case"SO":g="Special Order";break;case"CO":g="Closeout"}var h="",i="";a.info.images.length>3&&"Scratch & Dent"==g&&(h="sd-with-images",a.info.images[a.info.images.length-1]&&(i=a.info.images[a.info.images.length-1].replace(".jpeg","_medium.jpeg"),i.indexOf(".jpg")>-1&&(i=i.replace(".jpg","_medium.jpg"))));var j=a.info.images[0],k="";j&&("LG"==a.info.vendor?(j=j.replace(".jpeg","_large.jpeg"),k=a.info.vendor.replace(" ","-")):(j=j.replace(".jpeg","_medium.jpeg"),k=a.info.vendor.replace(" ","-"))),("Microwave Oven"==a.info.type||"Ventilation"==a.info.type||"Built-in Oven"==a.info.type||"Room Air Conditioner"==a.info.type||"Cooktop"==a.info.type)&&(k+=" contain"),("LG"==a.info.vendor&&("Room Air Conditioner"==a.info.type||"Cooktop"==a.info.type||"Microwave Oven"==a.info.type||"Cooking Accessory"==a.info.type)||"Range"==a.info.type&&"Slide-In"==c.Kind)&&(k+=" contain_override");var l="",m="";"Total Capacity (cubic feet)"in c&&(m=['<div class="spec-wrap">',"<dt>CAPACITY</dt>","<dd>"+c["Total Capacity (cubic feet)"]+"</dd>","</div>"].join(""));var n="";"dBA"in c&&(n=['<div class="spec-wrap">',"<dt>Decibals</dt>","<dd>"+c.dBA+"</dd>","</div>"].join(""));var o="";"Sones"in c&&(o=['<div class="spec-wrap">',"<dt>Sones</dt>","<dd>"+c.Sones+"</dd>","</div>"].join(""));var p="";"CFM"in c&&(p=['<div class="spec-wrap">',"<dt>CFM</dt>","<dd>"+c.CFM+"</dd>","</div>"].join(""));var q="";"Width"in c&&(q=['<div class="spec-wrap">',"<dt>Width</dt>","<dd>"+c["Overall Width"]+"</dd>","</div>"].join(""));var r="";"Heat Type"in c&&(r=['<div class="spec-wrap">',"<dt>Heat Type</dt>","<dd>"+c["Heat Type"]+"</dd>","</div>"].join(""));var s=a.info.title;"LG"==a.info.vendor&&a.info.title.indexOf("LG")<0&&(s="LG "+s);var t="";for(var u in a.info.tags)"Markdown"==a.info.tags[u]?t+=" clearance":"sale"==a.info.tags[u]&&(t+=" on_sale");return["<li id='p"+a.info.id+"' class='"+a.metafields.Condition.toLowerCase().replace("&","")+" "+t+" "+h+"'>",'<div class="snapshot">','<a href="/collections/'+b+"/products/"+a.info.handle+'" class="product-image '+k+'" data-first-image="'+j+'" data-last-image="'+i+'" style="background-image: url(\'http:'+j+"')\">","</a>","</div>",'<h4 class="product-title"><a href="/collections/'+b+"/products/"+a.info.handle+'">'+s+"</a></h4>",'<dl class="specs">',m,l,n,p,o,r,q,'<div class="spec-wrap">',"<dt>MODEL</dt>","<dd>"+a.info.handle.split("-")[0]+"</dd>","</div>",'<div class="spec-wrap">',"<dt>SERIAL</dt>","<dd>"+a.info.handle.split("-")[1]+"</dd>","</div>","</dl>",'<div class="price-condition">','<dl class="price">',"<dt><span hidden>Price</span></dt>","<dd>$"+a.info.price/100+"</dd>","</dl>",'<div class="count-breakout">',"<div>",'<span class="tag-count '+a.metafields.Condition.replace("&","").toLowerCase()+'">',g,"</span>","</div>","</div>","</div>","</li>"].join("")},d=this,e=function(b,c,e){var f=!1,g=!1;if(b.find("li").length>0){var i=function(i){var j=a(this).attr("data-filter-index");if(d.filtered[j].info.id==d.filtered[h].info.id)return g=!0,!1;if(d.filtered[h].info[d.sort_property]<d.filtered[j].info[d.sort_property]){if(a(this).before(c),b.find("li").length>e){var k=b.find("li:last-child");f=k.clone(),k.remove()}return g=!0,!1}return i==b.find("li").length-1&&e-1>i?(a(this).after(c),g=!0,!1):void 0};b.find("li").each(i)}else b.append(c),g=!0;return{placed_item:g,add_to_next:f}},f=!0,g=a("ul.product-grid").clone();g.empty();for(var h in this.filtered){f=!1;var i=a(c(this.filtered[h])).attr("data-filter-index",h),j=this.settings.paginate*this.page,k=e(g,i,j);if(k.add_to_next&&this.queuedForScroll.unshift(k.add_to_next),!k.placed_item)if(this.queuedForScroll.length>0)for(var l in this.queuedForScroll){var m=a(this.queuedForScroll[l]).attr("data-filter-index"),n=0;if(d.filtered[m].info.id==d.filtered[h].info.id){n=1;break}if(d.filtered[h].info[d.sort_property]<d.filtered[m].info[d.sort_property]){n=2,this.queuedForScroll.splice(l-1,0,i);break}if(l==this.queuedForScroll.length-1){n=3,this.queuedForScroll.push(i);break}}else this.queuedForScroll.push(i)}a("ul.product-grid").replaceWith(g),this.addResultsButton(),a(this.element).find("ul.product-grid").removeClass("loading"),f&&this.all_loads_in&&a("ul.product-grid").html(["<li class='emtpy-message'>","Nothing matched your filter criteria.","<a href='#' class='clear-all'>","Clear All <i class='icon icon-close'></i>","</a>","</li>"].join("")),this.getProductNumbers(),this.afterDump()},addResultsButton:function(){if(this.queuedForScroll.length>0){var b=this.settings.paginate;this.queuedForScroll.length<b&&(b=this.queuedForScroll.length);var c=a(['<div class="show-results">','<button class="btn btn-purple" id="add-results">',"Show "+b+" more results.","</button>","</div>"].join(""));a(".show-results").length>0?a(".show-results").replaceWith(c):a("ul.product-grid").after(c);var d=this;a("#add-results").click(function(){d.infiniteScroll()})}else a(".show-results").replaceWith(['<div class="show-results">','<button class="btn disabled" id="add-results">',"You've reached the end","</button>","</div>"].join(""))},registerActions:function(){var b=this,c=a(this.element);a("ul.tick-boxes button").click(function(b){b.preventDefault(),a("ul.product-grid").addClass("loading"),a(this).toggleClass("active"),setTimeout(function(){c.trigger("filterOptionsChanged")},200)}),a("a.clear-all").click(function(b){b.preventDefault(),a.address.queryString("")}),a("#add-results").click(function(){b.infiniteScroll()}),a(this.element).find("#options-go-here h3").unbind("click"),a(this.element).find("#options-go-here h3").click(function(){a(this).toggleClass("active")})},setActiveOptionsToHash:function(){var b={};a("#options-go-here").find("ul.tick-boxes button.active").each(function(){var c=a(this).attr("name"),e=a(this).attr("value");b[c]==d&&(b[c]=[]),b[c].push(e)});var c=jQuery.param(b,!0);a.address.queryString(c)},infiniteScroll:function(){var b=this,c=function(){a("ul.product-grid").removeClass("adding-products"),b.page=b.page+1;for(var c=0;c<b.settings.paginate;)a("ul.product-grid").append(b.queuedForScroll.shift()),c++;b.scroll_adding=!1};c(),this.addResultsButton(),this.getProductNumbers(),this.afterDump()},afterDump:function(){a(this.element).trigger("afterDump")},getProductNumbers:function(){var b=Object.keys(this.filtered).length,c=b-this.queuedForScroll.length,d="Showing "+c+" / "+b+" Appliances";a(".result_count").html(d)},refresh:function(){somePrivateMethod("refresh")},setCollectionHandle:function(a){this.collection_handle=a},getSomeInfo:function(){return this.someInfo},getPrivateInfo:function(){return h}}),a.fn[f]=function(b){var c=arguments;if(b===d||"object"==typeof b)return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var g;return this.each(function(){var d=a.data(this,"plugin_"+f);d instanceof e&&"function"==typeof d[b]&&(g=d[b].apply(d,Array.prototype.slice.call(c,1))),"destroy"===b&&a.data(this,"plugin_"+f,null)}),g!==d?g:this}}}(jQuery,window,document);